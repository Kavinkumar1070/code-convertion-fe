<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progress Indicator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../icon-delete/iconly.css">
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.css">

</head>
<style>
    .hidden {
        display: none !important;
    }

    .first>i {
        font-family: FontAwesome;
        font-style: normal;
        color: #33a852;
        margin-right: 20px;
    }
</style>

<body>

    <div class="container">
        <div class="progress-container">
            <!-- Step 1 - Completed -->
            <div onclick="skipStep(event)" id="step1" class="step in-progress">
                <div class="circle">
                    <div class="inner-circle"></div>
                    <div class="line"></div>
                </div>
                <div class="step-label">STEP 1</div>
                <div class="step-heading">Select Source</div>
                <div class="step-status">In-Process</div>
            </div>
            <!-- Step 2 - Completed -->
            <div onclick="skipStep(event)" id="step2" class="step pending">
                <div class="circle">
                    <div class="inner-circle hidden"></div>
                    <div class="line"></div>
                </div>
                <div class="step-label">STEP 2</div>
                <div class="step-heading">Model Processing</div>
                <div class="step-status">Pending</div>
            </div>

            <!-- Step 3 - Completed -->
            <div onclick="skipStep(event)" id="step3" class="step pending ">
                <div class="circle">
                    <div class="inner-circle hidden"></div>
                    <div class="line"></div>
                </div>
                <div class="step-label">STEP 3</div>
                <div class="step-heading">Role Selection</div>
                <div class="step-status">Pending</div>
            </div>

            <!-- Step 4 - Pending -->
            <div onclick="skipStep(event)" id="step4" class="step pending">
                <div class="circle">
                    <div class="inner-circle hidden"></div>
                </div>
                <div class="step-label">STEP 4</div>
                <div class="step-heading">Validate JSON</div>
                <div class="step-status">Pending</div>
            </div>
        </div>

        <p id="change-name">Select Source</p>
        <div class="content-container">
            <!-- ############################################################################################################## -->

            <p id="topic">Select Method of Link</p>
            <div class="files ">
                <label class="localr custom-radio">
                    <input type="radio" name="option" />
                    <span class="radio-checkmark"></span>
                    Local
                </label>
                <div id="local-input" class="space hidden">
                    <div class="custom-file-upload ">
                        <input type="text" onclick="openFile.click()" class="file-name-display"
                            placeholder="Choose a file..." readonly>
                        <div class="space1">
                            <div class="n">
                                <label for="file-upload" class="file-upload-label">Browse</label>
                            </div>
                        </div>
                        <input type="file" id="file-upload" class="file-upload-input" onchange="displayFileName()"
                            webkitdirectory directory multiple>
                    </div>
                </div>
                <label class="githubr custom-radio">
                    <input type="radio" name="option" />
                    <span class="radio-checkmark"></span>
                    Git Hub
                </label>
                <div id="git-input" class="space hidden">
                    <div class="custom-input">
                        <input type="text" id="url" placeholder="Enter the URL ">
                        <input type="text" id="token" placeholder="Enter the Token ">
                        <input type="text" id="branch" placeholder="Enter the Branch Name ">
                    </div>
                </div>
                <div class="fileloading loading hidden"></div>
            </div>

            <!-- ############################################################################################################## -->
            <div class="folders hidden">
                <div class="input-lable">
                    <label for="language">Language</label>
                    <label for="root" class="hidden">Root Directory</label>
                    <label for="routers" class="hidden">Routers</label>
                    <label for="schemas" class="hidden">Schemas</label>
                    <label for="controller" class="hidden">Controller</label>
                    <label for="dtos" class="hidden">DTOs</label>
                </div>
                <div class="inputboxs">
                    <!-- Language selection (single select) -->
                    <input type="text" id="language" placeholder="Select Language" readonly
                        onclick="toggleLanguageDropdown()" class="custom-input-field">

                    <!-- Language dropdown that appears on click -->
                    <div id="language-dropdown" class="hidden">
                        <ul id="dropdown">
                            <li onclick="selectLanguage('python')">Python</li>
                            <li onclick="selectLanguage('node.js')">Node.js</li>
                            <li onclick="selectLanguage('next.js')">Next.js</li>
                            <li onclick="selectLanguage('ROR')">ROR</li>
                        </ul>
                    </div>

                    <input type="text" name="root" id="root" placeholder="Enter the Root File Name"
                        class="hidden custom-input-field">
                    <input type="text" name="routers" id="routers" placeholder="Enter the Routers File Name"
                        class="hidden custom-input-field">
                    <input type="text" name="schemas" id="schemas" placeholder="Enter the Schemas File Name"
                        class="hidden custom-input-field">
                    <input type="text" name="controller" id="controller" placeholder="Enter the Controller File Name"
                        class="hidden custom-input-field">
                    <input type="text" name="dtos" id="dtos" placeholder="Enter the DTOs File Name"
                        class="hidden custom-input-field">
                </div>
                <div class="folloading loading hidden"></div>
            </div>

            <!-- ################################################################################################################################### -->
            <div class="role hidden">
                <h4 id="heading-role">Role</h4>
                <div class="role-containter">
                    <div class="role-containter adder">
                        <input type="text" class="styled-input" placeholder="Role Name">

                    </div>

                    <p id="add-role" onclick="addRole()"> <i class="fas fa-plus"></i> Add Role</p>

                </div>
                <div id="role-list"></div>
                <div class="roleloading loading hidden"></div>
            </div>
            <!-- ################################################################################################################################### -->
            <div class="json-container hidden">
                <div class="validate-json">
                    <div class="json-files">
                        <p>Choose File</p>
                        <div class="butt">
                            <div class="butcontainer">
                                <!-- <i class="icon icon-document"></i>
                                <button class="butt-file">index.json</button> -->
                            </div>
                        </div>
                    </div>
                    <div class="json-data">
                    </div>
                    <div class="jsonloading loading hidden"></div>
                </div>
            </div>
        </div>
        <div class="popup hidden">
            <div class="popup-content">
                <div class="first"><i class="fas fa-check-circle tick-icon"
                        style="color: #33a852; font-size: 24px;"></i>
                </div>
                <div class="middel">
                    <p style="color: #2a732c; font-weight: 700;">Success !</p>
                    <p style="color: #2a732c;">Your file has been successfully converted and is ready to use.</p>
                </div>
                <div class="last">
                    <span class="close-btn" onclick="closePopup()">&times;</span>
                </div>
            </div>
        </div>
        <div class="footer">
            <div class="back">
                <p class="hidden" id="back-button" onclick="goBack()"><-- Back</p>
            </div>
            <div class="footerbutton">
                <button class="hidden" id="cancel">Cancel</button>
                <button class="hidden" id="edit">Edit</button>
                <button id="next">Next</button>
            </div>
        </div>



</body>
<script>
// Target the specific .adder and .role elements
const adderElement = document.querySelector('.role .adder');
const nextBtn = document.getElementById('next');
const roleSection = document.querySelector('.role');

// Function to update the button text based on input content inside the specific .adder
function updateButtonText() {
    let hasInput = false;
    const inputElements = adderElement.querySelectorAll('input[type="text"]'); // Only inputs inside this .adder

    inputElements.forEach((input) => {
        if (input.value.trim() !== "") {
            hasInput = true;
            nextBtn.textContent = hasInput ? 'Next' : 'Skip';
        }
    });

    nextBtn.textContent = hasInput ? 'Next' : 'Skip';
}

// IntersectionObserver to detect when .role section becomes visible
const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            // When .role section is visible, attach event listener and update button text
            adderElement.addEventListener('input', (event) => {
                if (event.target.matches('input[type="text"]')) {
                    updateButtonText(); // Only respond if an input inside this .adder is the target
                }
            });
            updateButtonText(); // Initial check when section becomes visible
        }
    });
}, { threshold: 0.1 }); // Adjust threshold if needed

// Start observing the .role section
observer.observe(roleSection);



    // Function to close the popup
    function closePopup() {
        document.getElementById("popup").style.display = "none";
    }
    window.onload = function () {
        // Hide all fields except for the language input on page load
        hideAllFields();
    };

    // Toggle dropdown visibility for language selection
    function toggleLanguageDropdown() {
        const dropdown = document.getElementById('language-dropdown');
        dropdown.classList.toggle('hidden');
    }

    // Select a language from the dropdown
    function selectLanguage(language) {
        // Set the language input field value
        document.getElementById('language').value = language;

        // Hide the language dropdown
        document.getElementById('language-dropdown').classList.add('hidden');

        // Show the corresponding fields based on the selected language
        showFieldsBasedOnLanguage(language);
    }

    // Function to show the relevant input fields based on selected language
    function showFieldsBasedOnLanguage(language) {
        // Hide all fields initially
        hideAllFields();

        // Show the corresponding fields based on the selected language
        switch (language) {
            case 'python':
                showFields(['root', 'routers', 'schemas']);
                break;
            case 'node.js':
                showFields(['root', 'routers', 'schemas']);
                break;
            case 'next.js':
                showFields(['root', 'controller', 'dtos']);
                break;
            case 'ROR':
                showFields(['root', 'controller', 'schemas']);
                break;
            default:
                break;
        }
    }

    // Function to show specific fields
    function showFields(fields) {
        fields.forEach(field => {
            document.getElementById(field).classList.remove('hidden');
            document.querySelector(`label[for="${field}"]`).classList.remove('hidden');
        });
    }

    // Function to hide all fields
    function hideAllFields() {
        const allFields = ['root', 'routers', 'schemas', 'controller', 'dtos'];
        allFields.forEach(field => {
            document.getElementById(field).classList.add('hidden');
            document.querySelector(`label[for="${field}"]`).classList.add('hidden');
        });
    }



    const openFile = document.getElementById('file-upload');
    const fileNameDisplay = document.querySelector('.file-name-display');

    // Function to display the folder name of the selected file
    function displayFileName() {
        const fileInput = document.getElementById('file-upload');

        // If files are selected, show the folder name
        if (fileInput.files.length > 0) {
            const firstFilePath = fileInput.files[0].webkitRelativePath;

            // Extract the folder name by taking everything before the first '/' in the path
            const folderName = firstFilePath.split('/')[0];

            // Display the folder name
            fileNameDisplay.value = folderName;
        } else {
            // If no files are selected (after canceling), clear the displayed value
            fileNameDisplay.value = '';
        }
    }
    openFile.addEventListener('change', displayFileName);


    //varibles

    const local = document.querySelector('.localr');
    const localInput = document.getElementById('local-input');


    const github = document.querySelector('.githubr');
    const gitInput = document.getElementById('git-input');


    const nextButton = document.getElementById('next');
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const step4 = document.getElementById('step4');
    const fileContainer = document.querySelector('.files');
    const paragraphTopic = document.getElementById('topic');
    const folderContainer = document.querySelector('.folders');
    const roleContainer = document.querySelector('.role');
    const jsonContainer = document.querySelector('.json-container');

    const jsonInputBtnContainer = document.querySelector('.butt');

    const backButton = document.getElementById('back-button')
    const topic = document.getElementById('change-name')
    let clickedFilename = ' ';
    let roleArray = [];

    //    const addRole = document.getElementById('add-role');


    local.addEventListener('click', function () {
        localInput.classList.remove('hidden');
        gitInput.classList.add('hidden');
    });

    github.addEventListener('click', function () {
        localInput.classList.add('hidden');
        gitInput.classList.remove('hidden');
    });

    function addRole() {
        const roleAdder = document.querySelector('.adder');

        // Create the input box
        const inputBox = document.createElement('input');
        inputBox.setAttribute('type', 'text');
        inputBox.setAttribute('class', 'styled-input');
        inputBox.setAttribute('placeholder', 'Role Name');

        // Create the delete icon
        const deleteIcon = document.createElement('i');
        deleteIcon.classList.add('icon', 'icon-delete-button');

        // Add event listener to delete icon to remove both input and icon when clicked
        deleteIcon.addEventListener('click', function () {
            inputBox.remove(); // Remove the input field
            deleteIcon.remove(); // Remove the delete icon
        });

        // Append input box and delete icon to the role container
        roleAdder.append(inputBox);
        roleAdder.append(deleteIcon);
    }
    let screen = 1;

    // Handle "Next" button click event
    nextButton.addEventListener('click', async function () {
        console.log("next", screen)
        const filesData = document.querySelector('.file-upload-input');
        const progressContainer = document.querySelector('.progress-container');

        // Handle different screens based on current `screen` value
        if (screen === 1) {
            fileContainer.style.opacity = '60%'; // 40% opacity
            fileContainer.style.pointerEvents = 'none';
            document.querySelector('.fileloading').classList.remove('hidden')

            if (!localInput.classList.contains('hidden')) {
                // Local file upload
                if (filesData && filesData.files.length > 0) {
                    const formData = new FormData();
                    const excludeFolders = ['.venv', 'venv', '__pycache__', '.git', '.vscode'];

                    for (let file of filesData.files) {
                        const relativePath = file.webkitRelativePath;
                        if (!excludeFolders.some(folder => relativePath.includes(folder))) {
                            formData.append('files', file, relativePath);
                        }
                    }

                    if (formData.has('files')) {
                        try {
                            const response = await fetch('http://127.0.0.1:8000/upload-folder', {
                                method: 'POST',
                                body: formData
                            });
                            const result = await response.json();
                            fileContainer.style.opacity = '1'; // Full opacity
                            fileContainer.style.pointerEvents = 'auto';
                            document.querySelector('.fileloading').classList.add('hidden')

                            // Update UI on successful response
                            updateStepUI(step1, step2, fileContainer, paragraphTopic, folderContainer, null);
                            backButton.classList.remove('hidden');
                            topic.textContent = "Model Processing";
                            screen++;
                        } catch (error) {
                            fileContainer.style.opacity = '1'; // Full opacity
                            fileContainer.style.pointerEvents = 'auto';
                            document.querySelector('.fileloading').classList.add('hidden')
                            console.error('Error during file upload:', error);
                            alert('File upload failed. Please try again.');
                        }
                    } else {
                        fileContainer.style.opacity = '1'; // Full opacity
                        fileContainer.style.pointerEvents = 'auto';
                        document.querySelector('.fileloading').classList.add('hidden')
                        alert('No valid files to upload after excluding specific folders.');
                    }
                } else {
                    fileContainer.style.opacity = '1'; // Full opacity
                    fileContainer.style.pointerEvents = 'auto';
                    document.querySelector('.fileloading').classList.add('hidden')
                    alert('No folder selected. Please choose a folder.');
                }
            } else {
                // Git repository cloning
                const repoLink = document.getElementById('url').value;
                const token = document.getElementById('token').value;
                const branch = document.getElementById('branch').value;
                if (repoLink && branch) {
                    try {
                        const response = await fetch('http://127.0.0.1:8000/git-link', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ source_path: repoLink, token: token, branch: branch })
                        });

                        if (!response.ok) {
                            const errorDetails = await response.json();
                            throw new Error(errorDetails.detail || 'Unknown error occurred.');
                            fileContainer.style.opacity = '1'; // Full opacity
                            fileContainer.style.pointerEvents = 'auto';
                            document.querySelector('.fileloading').classList.add('hidden')
                        }

                        const result = await response.json();
                        fileContainer.style.opacity = '1'; // Full opacity
                        fileContainer.style.pointerEvents = 'auto';
                        document.querySelector('.fileloading').classList.add('hidden')
                        const uiActions = updateStepUI(step1, step2, fileContainer, paragraphTopic, folderContainer, null);
                        backButton.classList.remove('hidden');
                        topic.textContent = "Model Processing";
                        screen++;

                    } catch (error) {
                        fileContainer.style.opacity = '1'; // Full opacity
                        fileContainer.style.pointerEvents = 'auto';
                        document.querySelector('.fileloading').classList.add('hidden')
                        alert(`Failed to clone the repository. Details: ${error.message}`);
                    }
                } else {
                    fileContainer.style.opacity = '1'; // Full opacity
                    fileContainer.style.pointerEvents = 'auto';
                    document.querySelector('.fileloading').classList.add('hidden')
                    alert('Any One fields are required To cloning Project Please Select ("Local" or "Git Hub") .');
                }
            }
        } else if (screen === 2) {
            const language = document.getElementById('language').value;
            const root = document.getElementById('root').value;
            const routers = document.getElementById('routers').value;
            const schemas = document.getElementById('schemas').value;
            if (language && root && routers && schemas) {
                folderContainer.style.opacity = '60%'; // 40% opacity
                folderContainer.style.pointerEvents = 'none';
                document.querySelector('.folloading').classList.remove('hidden')
                try {
                    const response = await fetch('http://127.0.0.1:8000/copy_and_process/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            language: language,
                            root_directory: root,
                            routers_name: routers,
                            schemas_name: schemas
                        })
                    });

                    if (!response.ok) {
                        const errorDetails = await response.json();
                        throw new Error(errorDetails.detail || 'Unknown error occurred.');
                        folderContainer.style.opacity = '1'; // Full opacity
                        folderContainer.style.pointerEvents = 'auto';
                        document.querySelector('.folloading').classList.add('hidden')
                    }

                    const result = await response.json();
                    const uiActions = updateStepUI(step2, step3, folderContainer, null, roleContainer, null);
                    folderContainer.style.opacity = '1'; // Full opacity
                    folderContainer.style.pointerEvents = 'auto';
                    document.querySelector('.folloading').classList.add('hidden')
                    backButton.classList.remove('hidden')
                    topic.textContent = "Role Selection"
                    screen++;
                    if (roleArray) {
                        document.getElementById('next').textContent = 'Skip';
                    }   // Clear role array if necessary


                } catch (error) {
                    alert(`Error in processing the files: ${error.message}`);
                    folderContainer.style.opacity = '1'; // Full opacity
                    folderContainer.style.pointerEvents = 'auto';
                    document.querySelector('.folloading').classList.add('hidden')
                }
            } else {
                alert('All fields are required.');
            }
        } else if (screen === 3) {
            console.log('step3');
            if (jsonData) {
                jsonData.innerHTML = ''; // Clear displayed JSON data
            }
            if (jsonInputBtnContainer) {
                jsonInputBtnContainer.innerHTML = '';
            }
            // Clear role array if necessary



            const adderElement = document.querySelector('.adder');
            const inputElements = adderElement.querySelectorAll('input[type="text"]');

            inputElements.forEach((input) => {
                if (input.value.trim() !== "") {
                    roleArray.push(input.value.trim());
                }
            });
            // Check roleArray length after filling it
            try {

                roleContainer.style.opacity = '60%'; // 40% opacity
                roleContainer.style.pointerEvents = 'none'
                document.querySelector('.roleloading').classList.remove('hidden')
                const response = await fetch('http://127.0.0.1:8000/process_json/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    // Send  directly if `detail` wrapping is unnecessary
                    body: JSON.stringify(roleArray)
                });
                if (!response.ok) {
                    const errorDetails = await response.json();
                    console.error("Error details:", JSON.stringify(errorDetails, null, 2));
                    throw new Error(errorDetails.detail || 'Unknown error occurred.');
                    roleContainer.style.opacity = '1'; // Full opacity
                    roleContainer.style.pointerEvents = 'auto';
                    document.querySelector('.roleloading').classList.add('hidden')
                }

                const result = await response.json();
                console.log("roleArray", roleArray);
                const uiActions = updateStepUI(step3, step4, roleContainer, null, jsonContainer, null)
                document.querySelector('.roleloading').classList.add('hidden')
                roleContainer.style.opacity = '1'; // Full opacity
                roleContainer.style.pointerEvents = 'auto';
                backButton.classList.remove('hidden')
                topic.textContent = "Validate Json"
                screen++;
                document.querySelector('.container').classList.add('json');
                document.getElementById('edit').classList.remove('hidden');
                document.getElementById('next').textContent = 'Finish';
                document.getElementById('cancel').classList.remove('hidden');
                try {
                    const response = await fetch('http://127.0.0.1:8000/get-json-filename', { method: 'GET' });
                    if (!response.ok) {
                        const errorDetails = await response.json();
                        throw new Error(errorDetails.detail || 'Unknown error occurred.');
                    }

                    const result = await response.json();
                    console.log(result);
                    result.filenames.forEach(filename => {
                        const buttContainer = document.createElement('div');
                        buttContainer.classList.add('butcontainer')
                        const buttFile = document.createElement('button');
                        buttFile.classList.add('butt-file')
                        buttFile.innerHTML = filename;
                        const fileIcon = document.createElement('i')
                        fileIcon.classList.add('icon', 'icon-document')
                        buttContainer.append(fileIcon);
                        buttContainer.append(buttFile);
                        jsonInputBtnContainer.append(buttContainer)
                    });
                    clickedFilename = result.filenames[0];
                    console.log("clickedFilename", clickedFilename)
                    // Attach event listener only once to avoid duplicate events
                    const cancelBtnf = document.getElementById('cancel');
                    if (cancelBtnf && !cancelBtnf.hasListener) {
                        cancelBtnf.addEventListener('click', async function () {
                            try {
                                console.log("Cancel button clicked");

                                // Reset roleContainer UI to full opacity and re-enable pointer events
                                roleContainer.style.opacity = '1';
                                roleContainer.style.pointerEvents = 'auto';

                                // Hide the loading spinner
                                document.querySelector('.roleloading').classList.add('hidden');

                                // Clear the JSON data display area if needed
                                const jsonData = document.querySelector('.json-data');

                                // Optionally re-fetch JSON data for the selected filename
                                const response = await fetch(`http://127.0.0.1:8000/get-json?filename=${clickedFilename}`, { method: 'GET' });
                                if (!response.ok) {
                                    const errorDetails = await response.json();
                                    throw new Error(errorDetails.detail || 'Unknown error occurred.');
                                }

                                // Parse and display JSON response if applicable
                                const result = await response.json();
                                const contentDetails = result.content;
                                if (jsonData) {
                                    const addPre = document.createElement('pre');
                                    addPre.textContent = JSON.stringify(contentDetails, null, 2);
                                    jsonData.append(addPre);
                                    jsonData.setAttribute('contenteditable', false);
                                }
                                console.log("JSON data reset successfully");

                            } catch (error) {
                                console.error('Error handling cancel action:', error);
                                alert(`Failed to handle cancel action. Details: ${error.message}`);
                            }
                        });

                        // Set a flag to avoid re-attaching the listener on subsequent calls
                        cancelBtnf.hasListener = true;
                    }

                    try {
                        // Fetch JSON data
                        console.log("212121212")
                        const response = await fetch(`http://127.0.0.1:8000/get-json?filename=${clickedFilename}`, { method: 'GET' });
                        if (!response.ok) {
                            const errorDetails = await response.json();
                            throw new Error(errorDetails.detail || 'Unknown error occurred.');
                        }

                        // Parse JSON response
                        const result = await response.json();
                        const contentDetails = result.content;
                        const jsonData = document.querySelector('.json-data');
                        if (jsonData) {
                            jsonData.innerHTML = '';
                        }
                        const addPre = document.createElement('pre');
                        addPre.textContent = JSON.stringify(contentDetails, null, 2);
                        jsonData.append(addPre)
                        console.log(result)
                        jsonData.setAttribute('contenteditable', false);

                    } catch (error) {
                        console.error('Error fetching JSON Check file Path and api :', error);
                    }
                } catch (error) {
                    alert(`Failed to process data. Details: ${error.message}`);
                }
            }
            catch (error) {
                console.error('Error fetching JSON Files:', error);
                roleContainer.style.opacity = '1'; // Full opacity
                roleContainer.style.pointerEvents = 'auto';
                document.querySelector('.roleloading').classList.add('hidden')
            }
        } else if (screen === 4) {
            try {
                const jsonData = document.querySelector('.json-data');
                // Ensure content is not editable during the update
                jsonData.setAttribute('contenteditable', 'false');
                const editedData = jsonData.textContent;  // Get the edited content
                document.querySelector('.jsonloading').classList.remove('hidden')
                jsonContainer.style.opacity = '60%'; // 40% opacity
                jsonContainer.style.pointerEvents = 'none'
                try {
                    const jsonDataParsed = JSON.parse(editedData);  // Ensure the edited data is valid JSON

                    const response = await fetch(`http://127.0.0.1:8000/update/json?filename=${clickedFilename}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ content: jsonDataParsed })  // Ensure this structure matches your API expectations
                    });

                    if (!response.ok) {
                        const errorDetails = await response.json();  // Get error details from response
                        console.error('Error response:', errorDetails);  // Log the full error response
                        throw new Error(errorDetails.detail || 'Unknown error occurred.');
                        jsonContainer.style.opacity = '1'; // Full opacity
                        jsonContainer.style.pointerEvents = 'auto';
                        document.querySelector('.jsonloading').classList.add('hidden')
                    }
                    jsonContainer.style.opacity = '1'; // Full opacity
                    jsonContainer.style.pointerEvents = 'auto';
                    document.querySelector('.jsonloading').classList.add('hidden')
                    const result = await response.json();  // Parse the success response
                    console.log('Success:', result);
                    updateStepUI(step4, null, null, null, null, null);
                    const popup = document.querySelector('.popup');
                    popup.classList.remove('hidden');
                } catch (error) {
                    console.error('Error updating JSON:', error);  // Log the error object
                    jsonContainer.style.opacity = '1'; // Full opacity
                    jsonContainer.style.pointerEvents = 'auto';
                    document.querySelector('.jsonloading').classList.add('hidden')
                    alert('Failed to update JSON: ' + error.message);  // Show error message to user
                }
            } catch (error) {
                console.error("An error occurred:", error);
            }

        }
    });

    // Declare a global variable to store the clicked filename

    // Add click event listener to the parent container for file selection
    const buttons = document.querySelector('.butt');
    buttons.addEventListener('click', async function (event) {
        if (event.target && event.target.classList.contains('butt-file')) {
            clickedFilename = event.target.textContent;  // Store the clicked filename globally
            try {
                // Fetch JSON data
                const response = await fetch(`http://127.0.0.1:8000/get-json?filename=${clickedFilename}`, { method: 'GET' });
                if (!response.ok) {
                    const errorDetails = await response.json();
                    throw new Error(errorDetails.detail || 'Unknown error occurred.');
                }

                // Parse JSON response
                const result = await response.json();
                const contentDetails = result.content;
                const jsonData = document.querySelector('.json-data');
                jsonData.innerHTML = '';  // Clear previous content

                const addPre = document.createElement('pre');
                addPre.textContent = JSON.stringify(contentDetails, null, 2);
                jsonData.append(addPre);
                console.log(result);

            } catch (error) {
                alert(`Failed to process data. Details: ${error.message}`);
            }
        }
    });

    // Add event listener to the 'edit' button
    const edit = document.getElementById('edit');
    const finish = document.getElementById('next');
    const jsonData = document.querySelector('.json-data');  // Assuming this is the editable content container

    edit.addEventListener('click', function () {
        const isEditable = jsonData.isContentEditable;
        jsonData.setAttribute('contenteditable', !isEditable);
        edit.textContent = isEditable ? 'Edit' : 'Save';
    });


    // Update step UI function
    function updateStepUI(currentStep, nextStep, hideContainer1, hideContainer2, showContainer, isBack = false, topic) {
        if (isBack) {
            // Going back: mark the current step as pending
            currentStep.classList.remove('in-progress');
            currentStep.classList.add('pending');
            currentStep.children[0].classList.remove('completed');
            currentStep.children[0].children[0].classList.add('hidden')
            currentStep.lastElementChild.textContent = 'Pending';


            // Mark the previous step as in-progress
            if (nextStep) {
                nextStep.classList.remove('completed');
                nextStep.children[0].classList.remove('completed');
                nextStep.classList.add('in-progress');
                nextStep.children[0].children[0].textContent = '';
                nextStep.children[0].children[0].classList.add('inner-circle');
                nextStep.children[0].children[0].classList.remove('hidden');
                nextStep.lastElementChild.textContent = 'InProgress';
            }
        } else {
            // Move forward: mark the current step as completed
            currentStep.classList.remove('in-progress');
            currentStep.classList.add('completed');
            currentStep.children[0].classList.add('completed');
            currentStep.children[0].children[0].textContent = '✔';
            currentStep.lastElementChild.textContent = 'Completed';
            currentStep.children[0].children[0].classList.remove('inner-circle')

            if (nextStep) {
                nextStep.classList.remove('pending');
                nextStep.classList.add('in-progress');
                nextStep.children[0].children[0].classList.remove('hidden');
                nextStep.lastElementChild.textContent = 'InProgress';
                document.getElementById('change-name').textContent = topic;
            }

            if (hideContainer1) hideContainer1.classList.add('hidden');
            if (hideContainer2) hideContainer2.classList.add('hidden');
            if (showContainer) showContainer.classList.remove('hidden');
        }

        // Update container visibility
        if (hideContainer1) hideContainer1.classList.add('hidden');
        if (hideContainer2) hideContainer2.classList.add('hidden');
        if (showContainer) showContainer.classList.remove('hidden');
    }

    function goBack() {
        console.log("goback", screen)
        if (screen === 2) {
            // Going back from step 2 to step 1
            console.log('step1');
            updateStepUI(step2, step1, folderContainer, null, fileContainer, true);
            backButton.classList.add('hidden');
            topic.textContent = 'Select Source';
            paragraphTopic.classList.remove('hidden')
        } else if (screen === 3) {
            // Going back from step 3 to step 2
            console.log('step2');
            updateStepUI(step3, step2, roleContainer, null, folderContainer, true);
            topic.textContent = 'Model Processing'
        } else if (screen === 4) {
            console.log('step3');
            updateStepUI(step4, step3, jsonContainer, null, roleContainer, true);
            topic.textContent = 'Role Selection'
            document.querySelector('.container').classList.remove('json');
            edit.classList.add('hidden');
            document.getElementById('cancel').classList.add('hidden');
            finish.textContent = "Next";
            document.querySelector('.popup').classList.add('hidden');
        } else {
            console.log('Already at the beginning');
        }
        // Update screen counter
        screen--;
    }
    // Function for skipping a step
    function skipStep(event) {
        if (event && event.target && event.target.id) {
            // Check if the clicked element is step1 and is completed
            if (event.target.id.includes('step1') && event.target.classList.contains('completed')) {
                console.log('step1');
                ToSelected(step1, [step2, step3, step4]); // Call ToSelected for step1
                screen = 1;
            }
            // Similarly for other steps
            else if (event.target.id.includes('step2') && event.target.classList.contains('completed')) {
                console.log('step2');
                ToSelected(step2, [step3, step4]); // Call ToSelected for step2
                screen = 2; // Update screen variable
            }
            else if (event.target.id.includes('step3') && event.target.classList.contains('completed')) {
                console.log('step3');
                ToSelected(step3, [step4]); // Call ToSelected for step3
                screen = 3; // Update screen variable
            }
            else {
                // Update screen variable
                console.log('You are in the last Step');
            }
        }
    }

    // Function to change the current step to 'in-progress' and others to 'pending'
    function ToSelected(currentStep, otherSteps) {
        // Helper function to hide all containers
        function hideAllContainers() {
            fileContainer.classList.add('hidden');
            folderContainer.classList.add('hidden');
            roleContainer.classList.add('hidden');
            jsonContainer.classList.add('hidden');
        }

        // Helper function to configure the step display
        function setStepDisplay(step, state, label) {
            step.classList.remove('completed', 'in-progress', 'pending');
            step.classList.add(state);
            step.children[0].classList.remove('completed');
            step.children[0].children[0].textContent = ''; // Clear content
            step.children[0].children[0].classList.toggle('hidden', state !== 'in-progress');
            step.children[0].children[0].classList.toggle('inner-circle', state === 'in-progress');
            step.lastElementChild.textContent = label;
        }

        // Configure the current step as 'in-progress'
        setStepDisplay(currentStep, 'in-progress', 'InProgress');
        document.querySelector('.popup').classList.add('hidden');
        edit.classList.add('hidden');
        document.getElementById('cancel').classList.add('hidden');

        // Show/hide specific containers and configure UI based on the current step
        hideAllContainers();
        switch (currentStep) {
            case step1:
                console.log("step1");
                fileContainer.classList.remove('hidden');
                topic.textContent = 'Select Source';
                paragraphTopic.classList.remove('hidden');
                backButton.classList.add('hidden');
                finish.textContent = "Next";
                document.querySelector('.container').classList.remove('json');
                break;
            case step2:
                console.log("step2");
                folderContainer.classList.remove('hidden');
                topic.textContent = 'Model Processing';
                finish.textContent = "Next";
                document.querySelector('.container').classList.remove('json');
                break;
            case step3:
                console.log("step3");
                roleContainer.classList.remove('hidden');
                topic.textContent = 'Role Selection';
                finish.textContent = "Next";
                document.querySelector('.container').classList.remove('json');
                break;
            default:
                console.log("step4");
                break;
        }

        // Set other steps to 'pending'
        otherSteps.forEach(step => setStepDisplay(step, 'pending', 'Pending'));
    }

</script>

</html>
<!-- if (da.children.length > 0) {  // Check if there's at least one child
console.log(da.children[0].classList.contains('in-progress'));
} else {
console.log('No children in the progress container.');
}
if(da.children[0].classList.contains('in-progress')){
console.log("sadfasd",da.children[0].id)
console.log('2312',da.childElementCount)
} -->