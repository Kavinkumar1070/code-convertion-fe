<!DOCTYPE html>
<html lang="en">
 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progress Indicator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../icon-delete/iconly.css">
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
 
</head>
<style>
    .hidden {
        display: none;
    }
</style>
 
<body>
 
    <div class="container">
        <div class="progress-container">
            <!-- Step 1 - Completed -->
            <div onclick="skipStep(event)" id="step1" class="step in-progress">
                <div class="circle">
                    <div class="inner-circle"></div>
                    <div class="line"></div>
                </div>
                <div class="step-label">STEP 1</div>
                <div class="step-heading">Select Source</div>
                <div class="step-status">In-Process</div>
            </div>
            <!-- Step 2 - Completed -->
            <div onclick="skipStep(event)" id="step2" class="step pending">
                <div class="circle">
                    <div class="inner-circle hidden"></div>
                    <div class="line"></div>
                </div>
                <div class="step-label">STEP 2</div>
                <div class="step-heading">Model Processing</div>
                <div class="step-status">Pending</div>
            </div>
 
            <!-- Step 3 - Completed -->
            <div onclick="skipStep(event)" id="step3" class="step pending ">
                <div class="circle">
                    <div class="inner-circle hidden"></div>
                    <div class="line"></div>
                </div>
                <div class="step-label">STEP 3</div>
                <div class="step-heading">Role Selection</div>
                <div class="step-status">pending</div>
            </div>
 
            <!-- Step 4 - Pending -->
            <div onclick="skipStep(event)" id="step4" class="step pending">
                <div class="circle">
                    <div class="inner-circle hidden"></div>
                </div>
                <div class="step-label">STEP 4</div>
                <div class="step-heading">Validate JSON</div>
                <div class="step-status">Pending</div>
            </div>
        </div>
 
        <p id="change-name">Select Source</p>
        <div class="content-container">
            <!-- ############################################################################################################## -->
 
            <p id="topic">Select Method of Link</p>
            <div class="files ">
                <label class="localr custom-radio">
                    <input type="radio" name="option" />
                    <span class="radio-checkmark"></span>
                    Local
                </label>
                <div id="local-input" class="space hidden">
                    <div class="custom-file-upload ">
                        <input type="text" onclick="openFile.click()" class="file-name-display"
                            placeholder="Choose a file..." readonly>
                        <div class="space1">
                            <div class="n">
                                <label for="file-upload" class="file-upload-label">Browse</label>
                            </div>
                        </div>
                        <input type="file" id="file-upload" class="file-upload-input" onchange="displayFileName()"
                            webkitdirectory directory multiple>
                    </div>
                </div>
                <label class="githubr custom-radio">
                    <input type="radio" name="option" />
                    <span class="radio-checkmark"></span>
                    Git Hub
                </label>
                <div id="git-input" class="space hidden">
                    <div class="custom-input">
                        <input type="text" id="url" placeholder="Enter the URL ">
                        <input type="text" id="token" placeholder="Enter the Token ">
                        <input type="text" id="branch" placeholder="Enter the Branch Name ">
                    </div>
                </div>
            </div>
 
            <!-- ############################################################################################################## -->
            <div class="folders hidden">
                <div class="input-lable">
                    <label for="language">Language</label>
                    <label for="root">Root Directory</label>
                    <label for="routers">Routers</label>
                    <label for="schemas">Schemas</label>
                </div>
                <div class="inputboxs">
                    <input type="text" name="language" id="language"
                        placeholder="Enter the Language(Python,ROR,etc...)">
 
                    <input type="text" name="root" id="root" placeholder="Enter the Root File Name">
 
                    <input type="text" name="routers" id="routers" placeholder="Enter the Routers File Name">
 
                    <input type="text" name="schemas" id="schemas" placeholder="Enter the Schemas File Name">
                </div>
                <div class="loading hidden"></div>
            </div>
            <!-- ################################################################################################################################### -->
            <div class="role hidden">
                <h4 id="heading-role">Role</h4>
                <div class="role-containter">
                    <div class="role-containter adder">
                        <input type="text" class="styled-input" placeholder="Role Name">
 
                    </div>
 
                    <p id="add-role" onclick="addRole()"> <i class="fas fa-plus"></i> Add Role</p>
 
                </div>
                <div id="role-list"></div>
                <div class="roleloading loading hidden"></div>
            </div>
            <!-- ################################################################################################################################### -->
            <div class="json-container hidden">
                <div class="validate-json">
                    <div class="json-files">
                        <p>Choose File</p>
                        <div class="butt">
                            <div class="butcontainer">
                                <!-- <i class="icon icon-document"></i>
                                <button class="butt-file">index.json</button> -->
                            </div>
                        </div>
                    </div>
                    <div class="json-data">
                    </div>
                </div>
            </div>
        </div>
        <div class="footer">
            <div class="back">
                <p id="back-button" onclick="goBack()"><-- Back</p>
            </div>
            <div class="footerbutton">
                <button id="cancel">Cancel</button>
                <button class="hidden" id="edit">Edit</button>
                <button id="next">Next</button>
            </div>
 
        </div>
 
 
</body>
<script>
 
 
 
    const openFile = document.getElementById('file-upload');
    function displayFileName() {
        const fileInput = document.getElementById('file-upload');
        const fileNameDisplay = document.querySelector('.file-name-display');
 
        if (fileInput.files.length > 0) {
            const firstFilePath = fileInput.files[0].webkitRelativePath;
 
            // Extract the folder name by taking everything before the first '/' in the path
            const folderName = firstFilePath.split('/')[0];
 
            // Display the folder name
            fileNameDisplay.value = folderName;
        }
    }
 
    //first Page
 
    //varibles
 
    const local = document.querySelector('.localr');
    const localInput = document.getElementById('local-input');
 
 
    const github = document.querySelector('.githubr');
    const gitInput = document.getElementById('git-input');
 
 
    const nextButton = document.getElementById('next');
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const step4 = document.getElementById('step4');
    const fileContainer = document.querySelector('.files');
    const paragraphTopic = document.getElementById('topic');
    const folderContainer = document.querySelector('.folders');
    const roleContainer = document.querySelector('.role');
    const jsonContainer = document.querySelector('.json-container');
 
    const JosnInputBtnContainer = document.querySelector('.butt');
    let clickedFilename = ' ';
 
    //    const addRole = document.getElementById('add-role');
 
 
    local.addEventListener('click', function () {
        localInput.classList.remove('hidden');
        gitInput.classList.add('hidden');
    });
 
    github.addEventListener('click', function () {
        localInput.classList.add('hidden');
        gitInput.classList.remove('hidden');
    });
 
    function addRole() {
        const roleAdder = document.querySelector('.adder');
 
        // Create the input box
        const inputBox = document.createElement('input');
        inputBox.setAttribute('type', 'text');
        inputBox.setAttribute('class', 'styled-input');
        inputBox.setAttribute('placeholder', 'Role Name');
 
        // Create the delete icon
        const deleteIcon = document.createElement('i');
        deleteIcon.classList.add('icon', 'icon-delete-button');
 
        // Add event listener to delete icon to remove both input and icon when clicked
        deleteIcon.addEventListener('click', function () {
            inputBox.remove(); // Remove the input field
            deleteIcon.remove(); // Remove the delete icon
        });
 
        // Append input box and delete icon to the role container
        roleAdder.append(inputBox);
        roleAdder.append(deleteIcon);
    }
    let screen = 1;
 
    // Handle "Next" button click event
    nextButton.addEventListener('click', async function () {
        console.log('dddd')
        const filesData = document.querySelector('.file-upload-input');
        const progressContainer = document.querySelector('.progress-container');
 
        // Handle different screens based on current `screen` value
        if (screen === 1) {
 
            if (!localInput.classList.contains('hidden')) {
                // Local file upload
                if (filesData && filesData.files.length > 0) {
                    const formData = new FormData();
                    const excludeFolders = ['.venv', 'venv', '__pycache__', '.git', '.vscode'];
 
                    for (let file of filesData.files) {
                        const relativePath = file.webkitRelativePath;
                        if (!excludeFolders.some(folder => relativePath.includes(folder))) {
                            formData.append('files', file, relativePath);
                        }
                    }
 
                    if (formData.has('files')) {
                        try {
                            const response = await fetch('http://127.0.0.1:8000/upload-folder', {
                                method: 'POST',
                                body: formData
                            });
                            const result = await response.json();
 
                            // Update UI on successful response
                            updateStepUI(step1, step2, fileContainer, paragraphTopic, folderContainer,null);
                            screen++;
                        } catch (error) {
                            console.error('Error during file upload:', error);
                            alert('File upload failed. Please try again.');
                        }
                    } else {
                        alert('No valid files to upload after excluding specific folders.');
                    }
                } else {
                    alert('No folder selected. Please choose a folder.');
                }
            } else {
                // Git repository cloning
                const repoLink = document.getElementById('url').value;
                const token = document.getElementById('token').value;
                const branch = document.getElementById('branch').value;
                if (repoLink && token && branch) {
                    try {
                        const response = await fetch('http://127.0.0.1:8000/git-link', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ source_path: repoLink, token: token, branch: branch })
                        });
 
                        if (!response.ok) {
                            const errorDetails = await response.json();
                            throw new Error(errorDetails.detail || 'Unknown error occurred.');
                        }
 
                        const result = await response.json();
 
                        const uiActions = updateStepUI(step1, step2, fileContainer, paragraphTopic, folderContainer, null);
                        screen++;
 
                    } catch (error) {
                        alert(`Failed to clone the repository. Details: ${error.message}`);
                    }
                } else {
                    alert('All fields are required for Git repository cloning.');
                }
            }
        } else if (screen === 2) {
            const language = document.getElementById('language').value;
            const root = document.getElementById('root').value;
            const routers = document.getElementById('routers').value;
            const schemas = document.getElementById('schemas').value;
            folderContainer.style.opacity = '40%'; // 40% opacity
            folderContainer.style.pointerEvents = 'none';
            document.querySelector('.loading').classList.remove('hidden')
            if (language && root && routers && schemas) {
                try {
                    const response = await fetch('http://127.0.0.1:8000/copy_and_process/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            language: language,
                            root_directory: root,
                            routers_name: routers,
                            schemas_name: schemas
                        })
                    });
 
                    if (!response.ok) {
                        const errorDetails = await response.json();
                        throw new Error(errorDetails.detail || 'Unknown error occurred.');
                    }
 
                    const result = await response.json();
                    const uiActions = updateStepUI(step2, step3, folderContainer, null, roleContainer,null);
                    folderContainer.style.opacity = '1'; // Full opacity
                    folderContainer.style.pointerEvents = 'auto';
                    document.querySelector('.loading').classList.add('hidden')
                    screen++;
 
                } catch (error) {
                    alert(`Error in processing the files: ${error.message}`);
                }
            } else {
                alert('All fields are required.');
            }
        } else if (screen === 3) {
            console.log('step3')
            let roleArray = [];
            roleArray.length = 0;
 
            document.querySelector('.roleloading').classList.remove('hidden')
            const adderElement = document.querySelector('.adder');
            const inputElements = adderElement.querySelectorAll('input[type="text"]');
 
            inputElements.forEach((input) => {
                if (input.value.trim() !== "") {
                    roleArray.push(input.value.trim());
                }
            });
            try {
                roleContainer.style.opacity = '40%'; // 40% opacity
                roleContainer.style.pointerEvents = 'none'
                const response = await fetch('http://127.0.0.1:8000/process_json/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    // Send  directly if `detail` wrapping is unnecessary
                    body: JSON.stringify(roleArray)
                });
                if (!response.ok) {
                    const errorDetails = await response.json();
                    console.error("Error details:", JSON.stringify(errorDetails, null, 2));
                    throw new Error(errorDetails.detail || 'Unknown error occurred.');
                }
 
                const result = await response.json();
                console.log("roleArray", roleArray);
                const uiActions = updateStepUI(step3, step4, roleContainer, null, jsonContainer,null)
                document.querySelector('.roleloading').classList.add('hidden')
                roleContainer.style.opacity = '1'; // Full opacity
                roleContainer.style.pointerEvents = 'auto';
                screen++;
                document.querySelector('.container').classList.add('json');
                document.getElementById('edit').classList.remove('hidden');
                document.getElementById('cancel').classList.add('hidden');
                document.getElementById('next').textContent = 'Finish';
                try {
                    const response = await fetch('http://127.0.0.1:8000/get-json-filename', { method: 'GET' });
                    if (!response.ok) {
                        const errorDetails = await response.json();
                        throw new Error(errorDetails.detail || 'Unknown error occurred.');
                    }
 
                    const result = await response.json();
                    console.log(result);
                    result.filenames.forEach(filename => {
                        const buttContainer = document.createElement('div');
                        buttContainer.classList.add('butcontainer')
                        const buttFile = document.createElement('button');
                        buttFile.classList.add('butt-file')
                        buttFile.innerHTML = filename;
                        const fileIcon = document.createElement('i')
                        fileIcon.classList.add('icon', 'icon-document')
                        buttContainer.append(fileIcon);
                        buttContainer.append(buttFile);
                        JosnInputBtnContainer.append(buttContainer)
                    });
                    clickedFilename = result.filenames[0];
                    console.log("clickedFilename", clickedFilename)
                    try {
                        // Fetch JSON data
                        console.log("212121212")
                        const response = await fetch(`http://127.0.0.1:8000/get-json?filename=${clickedFilename}`, { method: 'GET' });
                        if (!response.ok) {
                            const errorDetails = await response.json();
                            throw new Error(errorDetails.detail || 'Unknown error occurred.');
                        }
 
                        // Parse JSON response
                        const result = await response.json();
                        const contentDetails = result.content;
                        const jsonData = document.querySelector('.json-data');
                        const addPre = document.createElement('pre');
                        addPre.textContent = JSON.stringify(contentDetails, null, 2);
                        jsonData.append(addPre)
                        console.log(result)
                        jsonData.setAttribute('contenteditable', false);
                    } catch (error) {
                        console.error('Error fetching JSON Check file Path and api :', error);
                    }
                } catch (error) {
                    alert(`Failed to process data. Details: ${error.message}`);
                }
            }
            catch (error) {
                console.error('Error fetching JSON Files:', error);
            }
        }
        else {
            try {
                console.log('step4')
            } catch (error) {
                console.error("An error occurred:", error);
            }
 
        }
    });
 
    // Declare a global variable to store the clicked filename
 
    // Add click event listener to the parent container for file selection
    const buttons = document.querySelector('.butt');
    buttons.addEventListener('click', async function (event) {
        if (event.target && event.target.classList.contains('butt-file')) {
            clickedFilename = event.target.textContent;  // Store the clicked filename globally
            try {
                // Fetch JSON data
                const response = await fetch(`http://127.0.0.1:8000/get-json?filename=${clickedFilename}`, { method: 'GET' });
                if (!response.ok) {
                    const errorDetails = await response.json();
                    throw new Error(errorDetails.detail || 'Unknown error occurred.');
                }
 
                // Parse JSON response
                const result = await response.json();
                const contentDetails = result.content;
                const jsonData = document.querySelector('.json-data');
                jsonData.innerHTML = '';  // Clear previous content
 
                const addPre = document.createElement('pre');
                addPre.textContent = JSON.stringify(contentDetails, null, 2);
                jsonData.append(addPre);
                console.log(result);
 
            } catch (error) {
                alert(`Failed to process data. Details: ${error.message}`);
            }
        }
    });
 
    // Add event listener to the 'edit' button
    const edit = document.getElementById('edit');
    const finish = document.getElementById('next');
    const jsonData = document.querySelector('.json-data');  // Assuming this is the editable content container
 
    edit.addEventListener('click', function () {
        const isEditable = jsonData.isContentEditable;
        jsonData.setAttribute('contenteditable', !isEditable);
        edit.textContent = isEditable ? 'Edit' : 'Save';
        console.log("clickedFilenameedit", clickedFilename)
 
        if (!isEditable) {
            // When saving, parse and prepare data for updating
            const editedData = jsonData.textContent;
 
            finish.addEventListener('click', async function () {
                // Ensure content is not editable during the update
                jsonData.setAttribute('contenteditable', 'false');
                const editedData = jsonData.textContent;  // Get the edited content
 
                try {
                    const jsonDataParsed = JSON.parse(editedData);  // Ensure the edited data is valid JSON
                    console.log("clickedFilenameedited data jsoin", clickedFilename)
                    console.log("jsonDataParsed", jsonDataParsed)
 
                    const response = await fetch(`http://127.0.0.1:8000/update/json?filename=${clickedFilename}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ content: jsonDataParsed })  // Ensure this structure matches your API expectations
                    });
 
                    if (!response.ok) {
                        const errorDetails = await response.json();  // Get error details from response
                        console.error('Error response:', errorDetails);  // Log the full error response
                        throw new Error(errorDetails.detail || 'Unknown error occurred.');
                    }
 
                    const result = await response.json();  // Parse the success response
                    console.log('Success:', result);
                    alert('JSON updated successfully!');  // Feedback to user
                    updateStepUI(step4, null, null, null, null, null);
 
                } catch (error) {
                    console.error('Error updating JSON:', error);  // Log the error object
                    alert('Failed to update JSON: ' + error.message);  // Show error message to user
                }
            });
        }
    });
 
 
    // Update step UI function
    function updateStepUI(currentStep, nextStep, hideContainer1, hideContainer2, showContainer, isBack = false, topic) {
        if (isBack) {
            // Going back: mark the current step as pending
            currentStep.classList.remove('in-progress');
            currentStep.classList.add('pending');
            currentStep.children[0].classList.remove('completed');
            currentStep.children[0].children[0].classList.add('hidden')
            currentStep.lastElementChild.textContent = 'Pending';
 
 
            // Mark the previous step as in-progress
            if (nextStep) {
                nextStep.classList.remove('completed');
                nextStep.classList.add('in-progress');
                nextStep.children[0].children[0].textContent = '';
                nextStep.children[0].children[0].classList.add('inner-circle');
                nextStep.children[0].children[0].classList.remove('hidden');
                nextStep.lastElementChild.textContent = 'InProgress';
            }
        } else {
            // Move forward: mark the current step as completed
            currentStep.classList.remove('in-progress');
            currentStep.classList.add('completed');
            currentStep.children[0].classList.add('completed');
            currentStep.children[0].children[0].textContent = '✔';
            currentStep.lastElementChild.textContent = 'Completed';
            currentStep.children[0].children[0].classList.remove('inner-circle')
 
            if (nextStep) {
                nextStep.classList.remove('pending');
                nextStep.classList.add('in-progress');
                nextStep.children[0].children[0].classList.remove('hidden');
                nextStep.lastElementChild.textContent = 'InProgress';
                document.getElementById('change-name').textContent = topic;
            }
 
            if (hideContainer1) hideContainer1.classList.add('hidden');
            if (hideContainer2) hideContainer2.classList.add('hidden');
            if (showContainer) showContainer.classList.remove('hidden');
        }
 
        // Update container visibility
        if (hideContainer1) hideContainer1.classList.add('hidden');
        if (hideContainer2) hideContainer2.classList.add('hidden');
        if (showContainer) showContainer.classList.remove('hidden');
    }
 
    function goBack() {
        if (screen === 2) {
            // Going back from step 2 to step 1
            updateStepUI(step2, step1, folderContainer, null, fileContainer, true);
        } else if (screen === 3) {
            // Going back from step 3 to step 2
            updateStepUI(step3, step2, roleContainer, null, folderContainer, true);
        } else if (screen === 4) {
 
            updateStepUI(step4, step3, jsonContainer, null, roleContainer, true);
        } else {
            console.log('Already at the beginning');
        }
        // Update screen counter
        screen--;
    }
 
    // Function for skipping a step
    function skipStep(event) {
        if (event && event.target && event.target.id) {
            // Check if the clicked element is step1 and is completed
            if (event.target.id.includes('step1') && event.target.classList.contains('completed')) {
                console.log('step1');
                ToSelected(step1, [step2, step3, step4]); // Call ToSelected for step1
                screen = 1; // Update screen variable
            }
            // Similarly for other steps
            else if (event.target.id.includes('step2') && event.target.classList.contains('completed')) {
                console.log('step2');
                ToSelected(step2, [step3, step4]); // Call ToSelected for step2
                screen = 2; // Update screen variable
            }
            else if (event.target.id.includes('step3') && event.target.classList.contains('completed')) {
                console.log('step3');
                ToSelected(step3, [step4]); // Call ToSelected for step3
                screen = 3; // Update screen variable
            }
            else if (event.target.id.includes('step4') && event.target.classList.contains('completed')) {
                console.log('step4');
                ToSelected(step4, [step1, step2, step3]); // Call ToSelected for step4
                screen = 4; // Update screen variable
            }
        }
    }
   
    // Function to change the current step to 'in-progress' and others to 'pending'
    function ToSelected(goGo, otherPending) {
        // Change the current step to 'in-progress'
        goGo.classList.remove('completed');
        goGo.classList.add('in-progress');
        goGo.children[0].classList.remove('completed');
        goGo.children[0].children[0].textContent = ''; // Remove the checkmark or content
        goGo.children[0].children[0].classList.add('inner-circle');
        goGo.children[0].children[0].classList.remove('hidden');
        goGo.lastElementChild.textContent = 'InProgress';
   
        // Show and hide specific containers based on the current step
        if (goGo === step1) {
            console.log("step1");
            fileContainer.classList.remove('hidden');
            folderContainer.classList.add('hidden');
            roleContainer.classList.add('hidden');
            jsonContainer.classList.add('hidden');
        } else if (goGo === step2) {
            console.log("step2");
            fileContainer.classList.add('hidden');
            folderContainer.classList.remove('hidden');
            roleContainer.classList.add('hidden');
            jsonContainer.classList.add('hidden');
        } else if (goGo === step3) {
            console.log("step3");
            fileContainer.classList.add('hidden');
            folderContainer.classList.add('hidden');
            roleContainer.classList.remove('hidden');
            jsonContainer.classList.add('hidden');
        } else {
            console.log("step4");
            fileContainer.classList.add('hidden');
            folderContainer.classList.add('hidden');
            roleContainer.classList.add('hidden');
            jsonContainer.classList.remove('hidden');
        }
   
        // Change the other steps to 'pending'
        for (let i = 0; i < otherPending.length; i++) {
            let step = otherPending[i];
            step.classList.remove('completed');
            step.classList.remove('in-progress');
            step.classList.add('pending');
            step.children[0].classList.remove('completed');
            step.children[0].children[0].classList.add('hidden');
            step.lastElementChild.textContent = 'Pending';
        }
    }
   
 
</script>
 
</html>